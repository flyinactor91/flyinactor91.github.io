<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="../d3/d3.v3.min.js"></script>
    <style type="text/css">

html, body, #map {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

/*#select-opts div {
  padding: 5px;
  background-color: 'red';
  display: 'inline';
}*/

.stations, .stations svg {
  position: absolute;
}

.stations svg {
  width: 20px;
  height: 20px;
  padding-right: 100px;
  font: 10px sans-serif;
}

.stations circle {
  stroke: black;
  stroke-width: 1.5px;
}

    </style>
  </head>
  <body>
    <div id="map-header">
      <h2>Orlando Police Dispatches </h2>
      <!--<h4>Showing between 12:00 AM and </h4>-->
      <div id='select-opts' style='display: inline;'>
        <div id='opt-year'>Year: </div>
        <div id='opt-month'>Month: </div>
        <div id='opt-day'>Day:
          <input type='text' id='opt-day-field'></input>
        </div>
      </div>
    </div>
    <div id="map"></div>
    <script type="text/javascript">

function draw(data) {
  var format = d3.time.format("%Y-%m-%d %H:%M:%S")
  for (var i=0;i<data.length;i++) {
    data[i].lat = +data[i].lat;
    data[i].lon = +data[i].lon;
    data[i].datetime = format.parse(data[i].datetime);
  }
  
  var nested = d3.nest()
    .key(function(d) {
      return d.datetime.toISOString().substring(0 , 10);
    })
    .entries(data);
  function key_func(d) {
      return d['key'];
  }
  
  //Create the map
  google.maps.Map.prototype.clearOverlays = function() {
    for (var i = 0; i < allMarkers.length; i++ ) {
      allMarkers[i].setMap(null);
    }
    allMarkers.length = 0;
  }
  var map = new google.maps.Map(d3.select("#map").node(), {
    zoom: 12,
    center: new google.maps.LatLng(28.5086413 , -81.3601829),
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });
  
  //init empty overlay
  var overlay = new google.maps.OverlayView();
  
  function show_day(year , month , day , animate) {
    console.log("In func " + day);
    function pad2(num) {
      if (num < 10) { return '0' + num }
      return num;
    }
    var dString = year + '-' + pad2(month) + '-' + pad2(day);
    var filtered = nested.filter(function(d) { return d.key == dString; })[0].values;
    console.log(filtered);
    debugger;
    
    var newOverlay = new google.maps.OverlayView();
    
    newOverlay.onAdd = function() {
      debugger;
      d3.select('.stations').remove();
      
      var layer = d3.select(this.getPanes().overlayLayer).append("div")
        .attr("class", "stations");
      newOverlay.draw = function() {
        
        //debugger;
        var projection = newOverlay.getProjection(),
            padding = 10;
        
        var fillColors = {
          'violent': 'red',
          'nonviolent': 'blue',
          'transport': 'yellow',
          'oncall': 'magenta',
          'other': 'orange'
        };
        
        function transform(d) {
          var color = fillColors[d.value.category];
          d = new google.maps.LatLng(d.value.lat, d.value.lon);
          d = projection.fromLatLngToDivPixel(d);
          return d3.select(this)
              .style("left", (d.x - padding) + "px")
              .style("top", (d.y - padding) + "px")
              .style('fill' , color);
        }
        
        //debugger;
        console.log(filtered.values);
        var marker = layer.selectAll("svg")
            .data(d3.entries(filtered))
            .each(transform) // update existing markers
          .enter().append("svg:svg")
            .each(transform)
            .attr("class", "marker");
            
        marker.append("svg:circle")
            .attr("r", 4.5)
            .attr("cx", padding)
            .attr("cy", padding);
        
        //debugger;
        
      }
    }
    
    newOverlay.onRemove = function() {
      d3.select('.stations').remove();
    };
    
    d3.select("h2")
      .text("Orlando Police Dispatches " + year + '-' + month + '-' + day);
    
    d3.select('#opt-year').text('Year: ' + year + '  ');
    d3.select('#opt-month').text('Month: ' + month + '  ');
    d3.select('#opt-day-field').attr('value' , day);
    
    debugger;
    overlay.setMap(null);
    debugger;
    newOverlay.setMap(map);
    debugger;
    overlay = newOverlay;
    debugger;
  }
  show_day(2015 , 7 , 20 , false);
  
  var button = d3.select('#select-opts')
    .append('button')
      .text('Show');
  button.on('click' , function() {
    //var dayVal = d3.select('#opt-day-field').html(this.value);
    //var dayVal = d3.select('#opt-day-field').attr('text');
    var dayVal = document.getElementById('opt-day-field').value;
    //debugger;
    console.log(dayVal);
    console.log(parseInt(dayVal));
    show_day(2015 , 7 , parseInt(dayVal) , false);
  });
}

var jsonfile = "../data/opddata-2015-7.json"
d3.json(jsonfile , draw);
    </script>
  </body>
</html>

<!--
MDN and w3schools docs
http://bl.ocks.org/mbostock/899711
-->