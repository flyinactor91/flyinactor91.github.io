<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="../d3/d3.v3.min.js"></script>
    <style type="text/css">

html, body, #map {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

#map {
  height: 90%;
}

#map-header h2 {
  margin: 0px; 
}

#select-opts div {
  display: inline;
}

.stations, .stations svg {
  position: absolute;
}

.stations svg {
  width: 20px;
  height: 20px;
}

.stations circle {
  stroke: black;
  stroke-width: 1.5px;
}

    </style>
  </head>
  <body>
    <div id="map-header">
      <h2>Orlando Police Dispatches</h2>
      <div>Data ranges from 2009-05-09 to 2015-08-21. Mouseover/touch map elements to display event details. Changing year or month fetches new datafiles (use sparingly on mobile).</div>
      <div id='select-opts' style='display: inline;'>
        <div>
          <b>Year: </b>
          <input type='text' size='4' id='opt-year-field'></input>
        </div>
        <div>
          <b>Month: </b>
          <input type='text' size='2' id='opt-month-field'></input>
        </div>
        <div>
          <b>Day: </b>
          <input type='text' size='2' id='opt-day-field'></input>
        </div>
      </div>
      <div id='dispatch-details'>
        <div><b>Reason: </b><span id='det-reason'></span></div>
        <div><b>Category: </b><span id='det-category'></span></div>
        <div><b>Coords: </b><span id='det-coords'></div>
      </div>
    </div>
    <div id="map"></div>
    <script type="text/javascript">

function draw(data) {
  var format = d3.time.format("%Y-%m-%d %H:%M:%S")
  for (var i=0;i<data.length;i++) {
    data[i].lat = +data[i].lat;
    data[i].lon = +data[i].lon;
    data[i].datetime = format.parse(data[i].datetime);
  }
  
  var nested = d3.nest()
    .key(function(d) {
      return d.datetime.toISOString().substring(0 , 10);
    })
    .entries(data);
  function key_func(d) {
      return d['key'];
  }
  
  //Create the map
  google.maps.Map.prototype.clearOverlays = function() {
    for (var i = 0; i < allMarkers.length; i++ ) {
      allMarkers[i].setMap(null);
    }
    allMarkers.length = 0;
  }
  var map = new google.maps.Map(d3.select("#map").node(), {
    zoom: 12,
    center: new google.maps.LatLng(28.5086413 , -81.3601829),
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });
  
  //init empty overlay
  var overlay = new google.maps.OverlayView();
  
  function show_day(year , month , day , animate) {
    
    if ((year != load.year) || (month != load.month)) {
      window.location.href = 'index.html?year='+year+'&month='+month+'&day='+day;
    }
    
    var dString = year + '-' + pad2(month) + '-' + pad2(day);
    var filtered = nested.filter(function(d) { return d.key == dString; })[0].values;
    //console.log(filtered);
    //debugger;
    
    var newOverlay = new google.maps.OverlayView();
    
    newOverlay.onAdd = function() {
      //debugger;
      d3.select('.stations').remove();
      
      var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
        .attr("class", "stations");
      newOverlay.draw = function() {
        
        //debugger;
        var projection = newOverlay.getProjection(),
            padding = 10;
        
        var fillColors = {
          'violent': 'red',
          'nonviolent': 'blue',
          'transport': 'yellow',
          'oncall': 'magenta',
          'other': 'orange'
        };
        
        function transform(d) {
          var color = fillColors[d.value.category];
          d = new google.maps.LatLng(d.value.lat, d.value.lon);
          d = projection.fromLatLngToDivPixel(d);
          return d3.select(this)
              .style("left", (d.x - padding) + "px")
              .style("top", (d.y - padding) + "px")
              .style('fill' , color);
        }
        
        function caps(string) {
          return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        function showDetails(d) {
          d3.select('#det-reason').text(caps(d.value.reason));
          d3.select('#det-category').text(caps(d.value.category));
          d3.select('#det-coords').text(d.value.lat + ', ' + d.value.lon);
        }
        
        //debugger;
        //console.log(filtered.values);
        var marker = layer.selectAll("svg")
            .data(d3.entries(filtered))
            .each(transform) // update existing markers
          .enter().append("svg:svg")
            .each(transform)
            .attr("class", "marker");
            
        marker.append("svg:circle")
            .attr("r", '7')
            .attr("cx", padding)
            .attr("cy", padding)
            .on('mouseover' , showDetails)
            .on('click' , showDetails);
        
        //debugger;
        
      }
    }
    
    newOverlay.onRemove = function() {
      d3.select('.stations').remove();
    };
    
    d3.select('#opt-year-field').attr('value' , year);
    d3.select('#opt-month-field').attr('value' , month);
    d3.select('#opt-day-field').attr('value' , day);
    
    overlay.setMap(null);
    newOverlay.setMap(map);
    overlay = newOverlay;
  }
  show_day(load.year , load.month , load.day);
  
  var button = d3.select('#select-opts')
    .append('button')
      .text('Show');
  button.on('click' , function() {
    var yearVal = parseInt(document.getElementById('opt-year-field').value);
    var monthVal = parseInt(document.getElementById('opt-month-field').value);
    var dayVal = parseInt(document.getElementById('opt-day-field').value);
    show_day(yearVal , monthVal , dayVal);
  });
}

function urlParam(name){
  var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
  if (results !== null) {
    return results[1] || 0;
  } else {
    return null;
  }
}

function pad2(num) {
  if (num < 10) { return '0' + num }
  return num;
}

var load = {
  day: 1,
  month: 7,
  year: 2015
};

if (urlParam('year') !== null) {
  load.year= urlParam('year');
}
if (urlParam('month') !== null) {
  load.month = urlParam('month');
}
if (urlParam('day') !== null) {
  load.day = urlParam('day');
}
var jsonfile = '../data/opddata-' + load.year + '-' + pad2(load.month) + '.json';

d3.json(jsonfile , draw);
    </script>
  </body>
</html>

<!--
MDN and w3schools docs
http://bl.ocks.org/mbostock/899711
-->